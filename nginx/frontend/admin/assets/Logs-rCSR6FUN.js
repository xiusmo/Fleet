import{a as e,r as a,C as l,c as t,o as r,b as d,f as s,w as i,g as n,E as o,D as u,i as c,K as _,L as p,h as g,H as v,e as m,d as h,z as w,I as b,J as f}from"./index-Eg7O6Ff6.js";import{a as y}from"./index-fwOAAbVN.js";import{_ as k}from"./_plugin-vue_export-helper-BCo6x5W8.js";const I={class:"logs-container"},D={class:"page-header"},N={class:"card-header-with-action"},V={class:"filters-form"},z={class:"search-input"},S={class:"card-header-with-action"},x={key:0},Y={key:0},C={key:1},P={key:2},U={key:1},H={key:0,class:"pagination-container"},$={key:1,class:"no-data"},M={key:0,class:"log-detail-container"},j={class:"details-json"},O={class:"dialog-footer"},T=k({__name:"Logs",setup(k){const T=e([]),A=e(!1),B=a({currentPage:1,pageSize:20,total:0}),J=a({level:null,category:null,user_id:null,task_id:null,worker_id:null,search:"",start_date:null,end_date:null}),L=[{value:"debug",label:"调试"},{value:"info",label:"信息"},{value:"warning",label:"警告"},{value:"error",label:"错误"},{value:"critical",label:"严重"}],E=[{value:"system",label:"系统"},{value:"task",label:"任务"},{value:"worker",label:"工作节点"},{value:"user",label:"用户"},{value:"api",label:"API"},{value:"security",label:"安全"},{value:"push",label:"推送"},{value:"other",label:"其他"}],K=e(!1),R=e(null),q=async()=>{var e;A.value=!0;try{const a={skip:(B.currentPage-1)*B.pageSize,limit:B.pageSize};J.level&&(a.level=J.level),J.category&&(a.category=J.category),J.user_id&&!isNaN(parseInt(J.user_id))&&(a.user_id=parseInt(J.user_id)),J.task_id&&!isNaN(parseInt(J.task_id))&&(a.task_id=parseInt(J.task_id)),J.worker_id&&!isNaN(parseInt(J.worker_id))&&(a.worker_id=parseInt(J.worker_id)),J.search&&J.search.trim()&&(a.search=J.search.trim()),J.start_date&&(a.start_date=new Date(J.start_date).toISOString()),J.end_date&&(a.end_date=new Date(J.end_date).toISOString());const l=await y.logs.getAll(a);Array.isArray(l.data)?(T.value=l.data,l.data.length<B.pageSize&&1===B.currentPage?B.total=l.data.length:l.data.length===B.pageSize?B.total=(null==(e=l.headers)?void 0:e["x-total-count"])?parseInt(l.headers["x-total-count"]):B.currentPage*B.pageSize+B.pageSize:B.total=(B.currentPage-1)*B.pageSize+l.data.length):(T.value=[],B.total=0)}catch(a){o.error("获取日志列表失败："+(a.message||"未知错误")),T.value=[]}finally{A.value=!1}},F=async()=>{try{await f.confirm(`确定要清空${G()}的日志记录吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e={};J.level&&(e.level=J.level),J.category&&(e.category=J.category),J.user_id&&!isNaN(parseInt(J.user_id))&&(e.user_id=parseInt(J.user_id)),J.task_id&&!isNaN(parseInt(J.task_id))&&(e.task_id=parseInt(J.task_id)),J.worker_id&&!isNaN(parseInt(J.worker_id))&&(e.worker_id=parseInt(J.worker_id)),J.search&&J.search.trim()&&(e.search=J.search.trim()),J.start_date&&(e.start_date=new Date(J.start_date).toISOString()),J.end_date&&(e.end_date=new Date(J.end_date).toISOString()),A.value=!0,await y.logs.clear(e),o.success("日志已清空"),B.currentPage=1,await q()}catch(e){"cancel"!==e&&o.error("清空失败："+(e.message||"未知错误"))}finally{A.value=!1}},G=()=>{const e=[];if(J.level){const a=L.find((e=>e.value===J.level));e.push(`级别为"${(null==a?void 0:a.label)||J.level}"`)}if(J.category){const a=E.find((e=>e.value===J.category));e.push(`类别为"${(null==a?void 0:a.label)||J.category}"`)}return J.user_id&&e.push(`用户ID为${J.user_id}`),J.task_id&&e.push(`任务ID为${J.task_id}`),J.worker_id&&e.push(`工作节点ID为${J.worker_id}`),J.search&&J.search.trim()&&e.push(`包含"${J.search.trim()}"`),J.start_date&&e.push(`开始时间为${W(J.start_date)}`),J.end_date&&e.push(`结束时间为${W(J.end_date)}`),e.length>0?e.join("、"):"所有"},Q=()=>{Object.keys(J).forEach((e=>{J[e]=null})),J.search="",B.currentPage=1,q()},W=e=>{if(!e)return"-";const a=new Date(e);return isNaN(a.getTime())?"-":a.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})},X=e=>({debug:"info",info:"info",warning:"warning",error:"danger",critical:"danger"}[e]||"info"),Z=e=>{B.currentPage=e,q()},ee=e=>{B.pageSize=e,B.currentPage=1,q()},ae=()=>{(()=>{let e=!0;J.user_id&&isNaN(parseInt(J.user_id))&&(o.warning("用户ID必须是数字"),e=!1),J.task_id&&isNaN(parseInt(J.task_id))&&(o.warning("任务ID必须是数字"),e=!1),J.worker_id&&isNaN(parseInt(J.worker_id))&&(o.warning("工作节点ID必须是数字"),e=!1),J.start_date&&isNaN(new Date(J.start_date).getTime())&&(o.warning("开始日期无效"),e=!1),J.end_date&&isNaN(new Date(J.end_date).getTime())&&(o.warning("结束日期无效"),e=!1),J.start_date&&J.end_date&&new Date(J.start_date)>new Date(J.end_date)&&(o.warning("开始日期必须早于结束日期"),e=!1);return e})()&&(B.currentPage=1,q())},le=e=>{R.value=e,K.value=!0};return l((()=>{q()})),(e,a)=>{const l=n("el-button"),k=n("el-option"),G=n("el-select"),te=n("el-form-item"),re=n("el-input"),de=n("el-date-picker"),se=n("el-form"),ie=n("el-card"),ne=n("el-table-column"),oe=n("el-tag"),ue=n("el-table"),ce=n("el-pagination"),_e=n("el-empty"),pe=n("el-descriptions-item"),ge=n("el-descriptions"),ve=n("el-dialog"),me=u("loading");return r(),t("div",I,[d("div",D,[a[14]||(a[14]=d("h1",{class:"page-title"},"系统日志",-1)),s(l,{type:"danger",onClick:F,loading:A.value},{default:i((()=>a[13]||(a[13]=[c("清空日志")]))),_:1},8,["loading"])]),s(ie,{shadow:"never",class:"filters-card"},{header:i((()=>[d("div",N,[a[16]||(a[16]=d("span",null,"筛选条件",-1)),s(l,{type:"primary",size:"small",onClick:Q,disabled:A.value},{default:i((()=>a[15]||(a[15]=[c("重置")]))),_:1},8,["disabled"])])])),default:i((()=>[d("div",V,[s(se,{inline:!0,model:J,class:"filter-form"},{default:i((()=>[s(te,{label:"日志级别"},{default:i((()=>[s(G,{modelValue:J.level,"onUpdate:modelValue":a[0]||(a[0]=e=>J.level=e),placeholder:"选择级别",clearable:""},{default:i((()=>[(r(),t(_,null,p(L,(e=>s(k,{key:e.value,value:e.value,label:e.label},null,8,["value","label"]))),64))])),_:1},8,["modelValue"])])),_:1}),s(te,{label:"日志类别"},{default:i((()=>[s(G,{modelValue:J.category,"onUpdate:modelValue":a[1]||(a[1]=e=>J.category=e),placeholder:"选择类别",clearable:""},{default:i((()=>[(r(),t(_,null,p(E,(e=>s(k,{key:e.value,value:e.value,label:e.label},null,8,["value","label"]))),64))])),_:1},8,["modelValue"])])),_:1}),s(te,{label:"用户ID"},{default:i((()=>[s(re,{modelValue:J.user_id,"onUpdate:modelValue":a[2]||(a[2]=e=>J.user_id=e),placeholder:"输入用户ID",clearable:"",type:"number"},null,8,["modelValue"])])),_:1}),s(te,{label:"工作节点ID"},{default:i((()=>[s(re,{modelValue:J.worker_id,"onUpdate:modelValue":a[3]||(a[3]=e=>J.worker_id=e),placeholder:"输入工作节点ID",clearable:"",type:"number"},null,8,["modelValue"])])),_:1}),s(te,{label:"任务ID"},{default:i((()=>[s(re,{modelValue:J.task_id,"onUpdate:modelValue":a[4]||(a[4]=e=>J.task_id=e),placeholder:"输入任务ID",clearable:"",type:"number"},null,8,["modelValue"])])),_:1}),s(te,{label:"时间范围"},{default:i((()=>[s(de,{modelValue:J.start_date,"onUpdate:modelValue":a[5]||(a[5]=e=>J.start_date=e),type:"datetime",placeholder:"开始时间",clearable:"",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss","disabled-date":e=>J.end_date&&e>new Date(J.end_date)},null,8,["modelValue","disabled-date"]),a[17]||(a[17]=d("span",{style:{margin:"0 5px"}},"至",-1)),s(de,{modelValue:J.end_date,"onUpdate:modelValue":a[6]||(a[6]=e=>J.end_date=e),type:"datetime",placeholder:"结束时间",clearable:"",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss","disabled-date":e=>J.start_date&&e<new Date(J.start_date)},null,8,["modelValue","disabled-date"])])),_:1}),s(te,{label:"关键字"},{default:i((()=>[d("div",z,[s(re,{modelValue:J.search,"onUpdate:modelValue":a[7]||(a[7]=e=>J.search=e),placeholder:"搜索内容",clearable:"",onKeyup:g(ae,["enter"])},null,8,["modelValue"]),s(l,{type:"primary",onClick:ae,loading:A.value},{default:i((()=>a[18]||(a[18]=[c("搜索")]))),_:1},8,["loading"])])])),_:1})])),_:1},8,["model"])])])),_:1}),s(ie,{shadow:"never",class:"logs-card",style:{"margin-top":"20px"}},{header:i((()=>[d("div",S,[a[20]||(a[20]=d("span",null,"日志列表",-1)),s(l,{type:"primary",size:"small",onClick:q,loading:A.value},{default:i((()=>a[19]||(a[19]=[c("刷新")]))),_:1},8,["loading"])])])),default:i((()=>[v((r(),h(ue,{data:T.value,style:{width:"100%"},border:"","empty-text":"无数据","header-cell-style":{background:"var(--header-background)",color:"var(--header-text-color)"},onRowClick:le,"highlight-current-row":""},{default:i((()=>[s(ne,{prop:"id",label:"ID",width:"70"}),s(ne,{prop:"level",label:"级别",width:"100"},{default:i((e=>[s(oe,{type:X(e.row.level),size:"small"},{default:i((()=>[c(w(e.row.level),1)])),_:2},1032,["type"])])),_:1}),s(ne,{prop:"category",label:"类别",width:"120"}),s(ne,{prop:"message",label:"消息","min-width":"300","show-overflow-tooltip":""}),s(ne,{label:"相关ID",width:"200"},{default:i((e=>[e.row.user_id||e.row.worker_id||e.row.task_id?(r(),t("div",x,[e.row.user_id?(r(),t("div",Y,"用户ID: "+w(e.row.user_id),1)):m("",!0),e.row.worker_id?(r(),t("div",C,"工作节点ID: "+w(e.row.worker_id),1)):m("",!0),e.row.task_id?(r(),t("div",P,"任务ID: "+w(e.row.task_id),1)):m("",!0)])):(r(),t("span",U,"-"))])),_:1}),s(ne,{prop:"created_at",label:"时间","min-width":"180"},{default:i((e=>[c(w(W(e.row.created_at)),1)])),_:1}),s(ne,{label:"操作",width:"100",fixed:"right"},{default:i((e=>[s(l,{size:"small",type:"danger",plain:"",onClick:b((a=>(async e=>{try{await f.confirm("确定要删除此条日志记录吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),A.value=!0,await y.logs.delete(e.id),o.success("删除成功"),await q()}catch(a){"cancel"!==a&&o.error("删除失败："+(a.message||"未知错误"))}finally{A.value=!1}})(e.row)),["stop"]),disabled:A.value},{default:i((()=>a[21]||(a[21]=[c(" 删除 ")]))),_:2},1032,["onClick","disabled"])])),_:1})])),_:1},8,["data"])),[[me,A.value]]),B.total>0?(r(),t("div",H,[s(ce,{"current-page":B.currentPage,"onUpdate:currentPage":a[8]||(a[8]=e=>B.currentPage=e),"page-size":B.pageSize,"onUpdate:pageSize":a[9]||(a[9]=e=>B.pageSize=e),"page-sizes":[10,20,50,100,200],layout:"total, sizes, prev, pager, next, jumper",total:B.total,onSizeChange:ee,onCurrentChange:Z,disabled:A.value},null,8,["current-page","page-size","total","disabled"])])):A.value||0!==T.value.length?m("",!0):(r(),t("div",$,[s(_e,{description:"暂无数据"})]))])),_:1}),s(ve,{modelValue:K.value,"onUpdate:modelValue":a[11]||(a[11]=e=>K.value=e),title:"日志详情",width:"60%","close-on-click-modal":!1,onClosed:a[12]||(a[12]=e=>R.value=null)},{footer:i((()=>[d("span",O,[s(l,{onClick:a[10]||(a[10]=e=>K.value=!1)},{default:i((()=>a[22]||(a[22]=[c("关闭")]))),_:1})])])),default:i((()=>[R.value?(r(),t("div",M,[s(ge,{column:2,border:""},{default:i((()=>[s(pe,{label:"ID"},{default:i((()=>[c(w(R.value.id),1)])),_:1}),s(pe,{label:"级别"},{default:i((()=>[s(oe,{type:X(R.value.level),size:"small"},{default:i((()=>[c(w(R.value.level),1)])),_:1},8,["type"])])),_:1}),s(pe,{label:"类别"},{default:i((()=>[c(w(R.value.category),1)])),_:1}),s(pe,{label:"时间"},{default:i((()=>[c(w(W(R.value.created_at)),1)])),_:1}),s(pe,{label:"来源"},{default:i((()=>[c(w(R.value.source||"-"),1)])),_:1}),s(pe,{label:"相关用户ID"},{default:i((()=>[c(w(R.value.user_id||"-"),1)])),_:1}),s(pe,{label:"相关工作节点ID"},{default:i((()=>[c(w(R.value.worker_id||"-"),1)])),_:1}),s(pe,{label:"相关任务ID"},{default:i((()=>[c(w(R.value.task_id||"-"),1)])),_:1}),s(pe,{label:"消息",span:2},{default:i((()=>[c(w(R.value.message),1)])),_:1}),s(pe,{label:"详细信息 (JSON)",span:2},{default:i((()=>[d("pre",j,w(JSON.stringify(R.value.details,null,2)),1)])),_:1})])),_:1})])):m("",!0)])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-eedccbd0"]]);export{T as default};
