import{a as e}from"./index-fwOAAbVN.js";import{_ as a}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{a as l,r as t,C as r,c as o,o as i,b as d,f as s,w as n,g as u,E as p,D as c,i as m,H as f,d as v,z as w,J as h}from"./index-Eg7O6Ff6.js";const b={class:"workers-container"},g={class:"page-header"},y={class:"card-header-with-action"},_={class:"dialog-footer"},k=a({__name:"Workers",setup(a){const k=l([]),x=l(!1),V=l(!1),N=l("添加工作节点"),S=l(!1),C=t({id:null,name:"",description:"",endpoint:"",subdomain:"",capabilities:{}}),O=l("{}"),J=e=>{O.value=e},U={name:[{required:!0,message:"请输入节点名称",trigger:"blur"}],endpoint:[{required:!0,message:"请输入节点地址",trigger:"blur"},{pattern:/^(https?:\/\/\S+|\/\S+)/i,message:"请输入有效的URL地址或路径",trigger:"blur"}],subdomain:[{required:!0,message:"请输入子域名",trigger:"blur"}]},j=l(null),z=l(!1),T=async()=>{x.value=!0;try{const a=await e.workers.getAll();k.value=a.data}catch(a){p.error("获取工作节点失败")}finally{x.value=!1}},q=()=>{N.value="添加工作节点",S.value=!1,R(),O.value="{}",V.value=!0},D=e=>{N.value="编辑工作节点",S.value=!0,Object.keys(C).forEach((a=>{a in e&&("capabilities"===a?(C[a]=JSON.parse(JSON.stringify(e[a]||{})),(e=>{try{O.value=JSON.stringify(e||{},null,2)}catch(a){O.value="{}"}})(C[a])):C[a]=e[a])})),V.value=!0},E=e=>{D(e)},I=async()=>{if(j.value){try{C.capabilities=JSON.parse(O.value||"{}")}catch(a){return void p.error("节点能力 JSON 格式无效，请检查语法")}await j.value.validate((async a=>{if(a){z.value=!0;try{if(S.value){const a=C.id,l={...C};delete l.id,await e.workers.update(a,l),p.success("更新成功")}else{const a={...C};delete a.id,await e.workers.create(a),p.success("添加成功")}V.value=!1,T()}catch(l){p.error("保存失败")}finally{z.value=!1}}}))}},R=()=>{Object.keys(C).forEach((e=>{C[e]="id"===e?null:"capabilities"===e?{}:""})),O.value="{}",j.value&&j.value.resetFields()},B=e=>({online:{text:"在线",type:"success"},offline:{text:"离线",type:"info"},busy:{text:"忙碌中",type:"warning"},error:{text:"错误",type:"danger"}}[e]||{text:e,type:"info"}),L=e=>{if(!e)return"-";const a=new Date(e);return isNaN(a.getTime())?"-":a.toLocaleString("zh-CN")};return r((()=>{T()})),(a,l)=>{const t=u("el-button"),r=u("el-table-column"),S=u("el-tag"),D=u("el-table"),R=u("el-card"),A=u("el-input"),F=u("el-form-item"),H=u("el-form"),P=u("el-dialog"),W=c("loading");return i(),o("div",b,[d("div",g,[l[8]||(l[8]=d("h1",{class:"page-title"},"工作节点管理",-1)),s(t,{type:"primary",onClick:q},{default:n((()=>l[7]||(l[7]=[m("添加工作节点")]))),_:1})]),s(R,{shadow:"never",class:"workers-card"},{header:n((()=>[d("div",y,[l[10]||(l[10]=d("span",null,"工作节点列表",-1)),s(t,{type:"primary",size:"small",onClick:T,loading:x.value},{default:n((()=>l[9]||(l[9]=[m("刷新")]))),_:1},8,["loading"])])])),default:n((()=>[f((i(),v(D,{data:k.value,style:{width:"100%"},border:"","highlight-current-row":"",onRowClick:E},{default:n((()=>[s(r,{prop:"id",label:"ID",width:"60"}),s(r,{prop:"name",label:"名称","min-width":"120"}),s(r,{prop:"description",label:"描述","min-width":"150","show-overflow-tooltip":""},{default:n((e=>[m(w(e.row.description||"-"),1)])),_:1}),s(r,{prop:"endpoint",label:"节点地址","min-width":"180","show-overflow-tooltip":""}),s(r,{prop:"subdomain",label:"子域名","min-width":"120"}),s(r,{prop:"status",label:"状态",width:"100"},{default:n((e=>[s(S,{type:B(e.row.status).type},{default:n((()=>[m(w(B(e.row.status).text),1)])),_:2},1032,["type"])])),_:1}),s(r,{prop:"last_heartbeat",label:"最后心跳","min-width":"180"},{default:n((e=>[m(w(L(e.row.last_heartbeat)),1)])),_:1}),s(r,{prop:"created_at",label:"创建时间","min-width":"180"},{default:n((e=>[m(w(L(e.row.created_at)),1)])),_:1}),s(r,{label:"操作",width:"70",fixed:"right"},{default:n((a=>[s(t,{size:"small",type:"danger",plain:"",onClick:l=>(async(a,l)=>{l&&l.stopPropagation();try{await h.confirm(`确定要删除工作节点 "${a.name}" 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await e.workers.delete(a.id),p.success("删除成功"),T()}catch(t){"cancel"!==t&&p.error("删除失败")}})(a.row,l)},{default:n((()=>l[11]||(l[11]=[m(" 删除 ")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[W,x.value]])])),_:1}),s(P,{modelValue:V.value,"onUpdate:modelValue":l[6]||(l[6]=e=>V.value=e),title:N.value,width:"500px","destroy-on-close":""},{footer:n((()=>[d("div",_,[s(t,{onClick:l[5]||(l[5]=e=>V.value=!1)},{default:n((()=>l[13]||(l[13]=[m("取消")]))),_:1}),s(t,{type:"primary",onClick:I,loading:z.value},{default:n((()=>l[14]||(l[14]=[m(" 确认 ")]))),_:1},8,["loading"])])])),default:n((()=>[s(H,{ref_key:"formRef",ref:j,model:C,rules:U,"label-width":"100px"},{default:n((()=>[s(F,{label:"节点名称",prop:"name"},{default:n((()=>[s(A,{modelValue:C.name,"onUpdate:modelValue":l[0]||(l[0]=e=>C.name=e),placeholder:"请输入节点名称"},null,8,["modelValue"])])),_:1}),s(F,{label:"节点描述",prop:"description"},{default:n((()=>[s(A,{modelValue:C.description,"onUpdate:modelValue":l[1]||(l[1]=e=>C.description=e),placeholder:"请输入节点描述",type:"textarea",rows:2},null,8,["modelValue"])])),_:1}),s(F,{label:"节点地址",prop:"endpoint"},{default:n((()=>[s(A,{modelValue:C.endpoint,"onUpdate:modelValue":l[2]||(l[2]=e=>C.endpoint=e),placeholder:"请输入节点地址，例如：http://worker.example.com"},null,8,["modelValue"])])),_:1}),s(F,{label:"子域名",prop:"subdomain"},{default:n((()=>[s(A,{modelValue:C.subdomain,"onUpdate:modelValue":l[3]||(l[3]=e=>C.subdomain=e),placeholder:"请输入子域名"},null,8,["modelValue"])])),_:1}),s(F,{label:"节点能力",prop:"capabilities"},{default:n((()=>[s(A,{modelValue:O.value,"onUpdate:modelValue":l[4]||(l[4]=e=>O.value=e),placeholder:"请输入节点能力（JSON格式）",type:"textarea",rows:4,onInput:J},null,8,["modelValue"]),l[12]||(l[12]=d("div",{class:"form-item-tip"},'请输入有效的 JSON 格式，例如：{"gpu": true, "maxTasks": 5}（提交时会自动验证格式）',-1))])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue","title"])])}}},[["__scopeId","data-v-461cb782"]]);export{k as default};
